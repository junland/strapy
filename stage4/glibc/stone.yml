name        : glibc
version     : 2.33
release     : 1
summary     : The GNU libc libraries
license     :
    - GPL-2.0-or-later
    - LGPL-2.1-or-later
    - LGPL-2.1-or-later WITH GCC-exception-2.0
homepage    : https://www.gnu.org/software/libc
description : |
    The GNU libc libraries
upstreams   :
    - https://ftp.gnu.org/gnu/glibc/glibc-2.33.tar.xz: 2e2556000e105dbd57f0b6b2a32ff2cf173bde4f0d85dffccfd8b7e51a0677ff
environment : |
    # Fix build to use actual flags for more tuned glibc
    export CC="${CC} -B/usr/lib/gcc/x86_64-serpent-linux/11/%(libsuffix)"
    export LDFLAGS="${LDFLAGS} -Wl,-O2,-z,max-page-size=0x1000,--sort-common"
setup       : |
    # Patches ahoy!
    %patch %(pkgdir)/perf/fix-ld-audit-performance.patch
    %patch %(pkgdir)/serpent/0001-sysdeps-Add-support-for-default-directories.patch
    %patch %(pkgdir)/serpent/0001-Force-correct-RTLDLIST-for-ldd.patch
    %patch %(pkgdir)/stateless/make-hosts-file-stateless.patch
    %patch %(pkgdir)/stateless/Support-fallback-stateless-shells-path.patch
    %patch %(pkgdir)/stateless/Use-a-stateless-ld.so.conf.patch
    %patch %(pkgdir)/stateless/make-locale-cache-stateless.patch

    # Build only US UTF-8 locale for now
    echo "SUPPORTED_LOCALES=\
    en_US.UTF-8/UTF-8
    " > localedata/SUPPORTED

    mkdir build && cd build
    echo "LD_SO_CACHE=/var/cache/ldconfig/ld.so.cache" >> configparms
    echo "slibdir=/usr/lib%(libsuffix)" >> configparms
    echo "rtlddir=/usr/lib%(libsuffix)" >> configparms
    echo "sbindir=/usr/sbin" >> configparms
    echo "rootsbindir=/usr/sbin" >> configparms
    # Note this deliberately excludes libsuffix and is not an error
    echo "complocaledir=/usr/lib/locale" >> configparms

    ../configure %(options_configure) \
        --disable-crypt \
        --disable-obsolete-rpc \
        --disable-profile \
        --enable-add-ons \
        --enable-bind-now \
        --enable-cet \
        --enable-gnu-indirect-function \
        --enable-kernel=5.12 \
        --enable-lock-elision \
        --enable-plugin \
        --enable-stack-protector \
        --enable-stackguard-randomization \
        --enable-threads=posix \
        --enable-tunables \
        --without-selinux \
        libc_cv_include_x86_isa_level=no
        # Need support in linker
        #--enable-multi-arch \
        #--enable-static-pie \
build       : |
    %make -C build
install     : |
    %make_install build DESTDIR="%(installroot)" -C build
    %make localedata/install-locales DESTDIR="%(installroot)" -C build

    # Make stateless dirs for glibc /var/cache/locale /var/db /var/run
toolchain   : gnu
emul32      : true
tuning      :
    - asneeded: false
    #- avxwidth: false
    - base: false
    - bindnow: false
    - fortify: false
    - harden: false
