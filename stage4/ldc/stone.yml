name        : ldc
version     : 1.27.1
release     : 1
summary     : The LLVM-based D Compiler
license     :
    - Apache-2.0
    - BSD-3-Clause
    - BSL-1.0
homepage    : https://github.com/ldc-developers/ldc
description : |
    The LLVM-based D Compiler
upstreams   :
    - https://github.com/ldc-developers/ldc/releases/download/v1.27.1/ldc-1.27.1-src.tar.gz : 93c8f500b39823dcdabbd73e1bcb487a1b93cb9a60144b0de1c81ab50200e59c
    - https://github.com/ldc-developers/ldc/releases/download/v1.27.1/ldc2-1.27.1-linux-x86_64.tar.xz: 48d68e0747dc17b9b0d2799a2fffdc5ddaf986c649283c784830f19c4c82830c
setup       : |
    %patch %(pkgdir)/serpent/0001-Default-to-lld-but-don-t-pass-linker-to-compiler.patch
    %patch %(pkgdir)/stateless/0001-Fixups-for-packaging-and-stateless-config.patch

    %cmake -DBUILD_SHARED_LIBS=ON \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBASH_COMPLETION_COMPLETIONSDIR="/usr/share/bash-completion/completions" \
        -DLDC_INSTALL_LTOPLUGIN=ON \
        -DLDC_INSTALL_LLVM_RUNTIME_LIBS=ON \
        -DLDC_WITH_LLD=ON \
        -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld"
build       : |
    %cmake_build
install     : |
    %cmake_install
    cp "%(buildroot)/ldc2-%(version)-linux-x86_64/bin/dub" "%(installroot)/usr/bin/"

    # Stateless: Put file in patched stateless location
    install -Dm00644 %(installroot)/etc/ldc2.conf %(installroot)/usr/share/defaults/etc/ldc2.conf
    rm %(installroot)/etc/ldc2.conf
    rmdir  %(installroot)/etc
